{% extends "base.html" %}

{% block title %}
  {% if current_seller_plan %}{{ current_seller_plan.seller.display_name|default:current_seller_plan.seller.user.username }} Membership - {% elif current_plan %}Platform Membership - {% else %}Manage Membership - {% endif %}{{ block.super }}
{% endblock %}

{% block content %}

<style>
    .manage-subscription-card {
        max-width: 700px;
        margin: 20px auto;
        background: #ffffff;
        border-radius: 10px;
        padding: 30px;
        box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }

    .manage-subscription-card h1 {
        text-align: center;
        color: #1b4332;
        margin-bottom: 30px;
        padding-bottom: 15px;
        border-bottom: 2px solid #e0e0e0;
    }

    .section {
        margin-bottom: 35px;
    }

    .section h2 {
        color: #2d6a4f;
        font-size: 1.3em;
        margin-bottom: 20px;
        padding-bottom: 8px;
        border-bottom: 1px solid #e0e0e0;
    }

    .subscription-info {
        background: #f8f9fa;
        padding: 20px;
        border-radius: 8px;
        border-left: 4px solid #2d6a4f;
    }

    .subscription-info p {
        margin: 10px 0;
        font-size: 1.1em;
    }

    .subscription-info strong {
        color: #1b4332;
        min-width: 100px;
        display: inline-block;
    }

    .change-plan-form {
        background: #f8f9fa;
        padding: 20px;
        border-radius: 8px;
        border-left: 4px solid #2196f3;
    }

    .change-plan-form select {
        width: 100%;
        padding: 10px 12px;
        font-size: 16px;
        border: 1px solid #ccc;
        border-radius: 6px;
        margin-bottom: 15px;
        background: white;
    }

    .subscription-actions {
        background: #f8f9fa;
        padding: 20px;
        border-radius: 8px;
        border-left: 4px solid #ff9800;
    }

    .btn {
        padding: 12px 24px;
        border-radius: 6px;
        border: 1px solid #999;
        cursor: pointer;
        font-size: 16px;
        margin-right: 10px;
        margin-top: 10px;
    }

    .btn-primary {
        background: #f7f7f7;
        color: #333;
    }

    .btn-primary:hover {
        background: #e9e9e9;
    }

    .btn-cancel {
        background: #dc3545;
        color: white;
        border-color: #dc3545;
    }

    .btn-cancel:hover {
        background: #c82333;
        border-color: #bd2130;
    }

    .btn-resume {
        background: #28a745;
        color: white;
        border-color: #28a745;
    }

    .btn-resume:hover {
        background: #218838;
        border-color: #1e7e34;
    }

    .status-active {
        color: #28a745;
        font-weight: bold;
    }

    .status-inactive {
        color: #dc3545;
        font-weight: bold;
    }
</style>

<div class="manage-subscription-card">
    <h1>Manage Subscription</h1>

    <!-- Current Subscription Section -->
    <div class="section">
        <h2>Current Subscription</h2>
        <div class="subscription-info">
            {% if profile.is_active_member %}
                {% if current_seller_plan %}
                    <p><strong>Plan:</strong> {{ current_seller_plan.name }} ({{ current_seller_plan.seller.display_name|default:current_seller_plan.seller.user.username }})</p>
                    <p><strong>Price:</strong> {{ current_seller_plan.price_display }}</p>
                {% elif current_plan %}
                    <p><strong>Plan:</strong> {{ current_plan.name }}</p>
                    <p><strong>Price:</strong> {{ current_plan.price_display }}</p>
                {% else %}
                    <p><strong>Plan:</strong> {{ profile.membership_level }}</p>
                {% endif %}
                <p><strong>Status:</strong> 
                    {% if profile.auto_renew %}
                        <span class="status-active">Active</span>
                    {% else %}
                        <span class="status-inactive">Cancelled (ends on {{ profile.membership_expires|date:"M d, Y" }})</span>
                    {% endif %}
                </p>
                {% if profile.membership_expires %}
                    <p><strong>Ends:</strong> {{ profile.membership_expires|date:"M d, Y" }}</p>
                {% endif %}
            {% else %}
                <p>No active subscription.</p>
            {% endif %}
        </div>
    </div>

    <!-- Change Plan Section -->
    {% if profile.is_active_member %}
    <div class="section">
        <h2>Change Plan</h2>
        <div class="change-plan-form">
            <form method="post">
                {% csrf_token %}
                <select name="plan_slug" required>
                    <option value="">Select plan...</option>
                    {% for plan in plans %}
                        <option value="{{ plan.slug }}" {% if profile.membership_level == plan.slug %}selected{% endif %}>
                            {{ plan.name }} - {{ plan.price_display }}
                        </option>
                    {% endfor %}
                </select>
                <input type="hidden" name="plan_type" id="plan_type_input" value="admin">
                <button type="submit" name="update_plan" class="btn btn-primary">
                    Update Plan
                </button>
            </form>
            <script>
                // Set plan_type based on selected plan
                document.querySelector('select[name="plan_slug"]').addEventListener('change', function() {
                    const selectedValue = this.value;
                    const planTypeInput = document.getElementById('plan_type_input');
                    if (selectedValue && selectedValue.startsWith('seller_')) {
                        planTypeInput.value = 'seller';
                    } else {
                        planTypeInput.value = 'admin';
                    }
                });
            </script>
        </div>
    </div>

    <!-- Subscription Actions Section -->
    <div class="section">
        <h2>Subscription Actions</h2>
        <div class="subscription-actions">
            <form method="post">
                {% csrf_token %}
                {% if profile.auto_renew %}
                    <button type="submit" name="cancel_membership" class="btn btn-cancel">
                        Cancel Subscription
                    </button>
                {% else %}
                    <button type="submit" name="resume_membership" class="btn btn-resume">
                        Resume Subscription
                    </button>
                    {% if profile.membership_expires %}
                        <p style="margin-top: 15px; color: #666; font-size: 0.95em;">
                            Your subscription will end on <strong>{{ profile.membership_expires|date:"M d, Y" }}</strong>.
                        </p>
                    {% endif %}
                {% endif %}
            </form>
        </div>
    </div>
    {% endif %}
</div>

{% endblock %}

