{% extends "base.html" %}
{% load static %}

{% block title %}Statement - {{ block.super }}{% endblock %}

{% block extra_css %}
<style>
  .statement-container {
    max-width: 1200px;
    margin: 30px auto;
    padding: 20px;
  }

  .statement-header {
    background: white;
    padding: 25px;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    margin-bottom: 20px;
  }

  .statement-header h1 {
    color: #2d6a4f;
    margin-top: 0;
    margin-bottom: 5px;
  }

  .statement-header .subtext {
    color: #666;
    font-size: 0.9rem;
    margin-bottom: 20px;
  }

  .date-filter-section {
    background: #f9f9f9;
    padding: 20px;
    border-radius: 6px;
    margin-bottom: 20px;
  }

  .date-filter-row {
    display: flex;
    gap: 10px;
    align-items: center;
    flex-wrap: wrap;
  }

  .date-filter-row select,
  .date-filter-row input {
    padding: 8px 12px;
    border: 1px solid #ddd;
    border-radius: 4px;
    font-size: 0.95rem;
  }

  .date-filter-row select {
    min-width: 150px;
  }

  .date-filter-row input[type="date"] {
    min-width: 140px;
  }

  .btn-apply {
    padding: 8px 20px;
    background: #2d6a4f;
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-weight: bold;
  }

  .btn-apply:hover {
    background: #1b4332;
  }

  .period-summary {
    background: white;
    padding: 20px;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    margin-bottom: 20px;
  }

  .period-summary h2 {
    color: #2d6a4f;
    margin-top: 0;
    margin-bottom: 15px;
    font-size: 1.2rem;
  }

  .period-summary .date-range {
    color: #666;
    font-size: 0.9rem;
    margin-bottom: 15px;
  }

  .summary-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 20px;
  }

  .summary-item {
    text-align: center;
    padding: 15px;
    background: #f9f9f9;
    border-radius: 6px;
  }

  .summary-label {
    font-size: 0.85rem;
    color: #666;
    margin-bottom: 8px;
    font-weight: bold;
  }

  .summary-value {
    font-size: 1.5rem;
    font-weight: bold;
  }

  .summary-value.in {
    color: #2d6a4f;
  }

  .summary-value.out {
    color: #dc3545;
  }

  .summary-value.net {
    color: #333;
  }

  .transaction-section {
    background: white;
    padding: 25px;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    margin-bottom: 20px;
  }

  .transaction-section h2 {
    color: #2d6a4f;
    margin-top: 0;
    margin-bottom: 20px;
  }

  .transaction-table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 15px;
  }

  .transaction-table th,
  .transaction-table td {
    padding: 10px 12px;
    text-align: left;
    border-bottom: 1px solid #ddd;
    font-size: 0.95rem;
  }

  .transaction-table th {
    background: #2d6a4f;
    color: white;
    font-weight: bold;
    position: sticky;
    top: 0;
    border-bottom: 2px solid #1b4332;
  }

  .transaction-table tbody tr:hover {
    background: #f9f9f9;
  }

  .transaction-table tbody tr:last-child {
    border-bottom: 2px solid #333;
  }

  .transaction-table .amount-in {
    color: #000;
    font-weight: bold;
  }

  .transaction-table .amount-out {
    color: #000;
    font-weight: bold;
  }

  .transaction-table .balance {
    font-weight: bold;
    color: #000;
  }

  .tax-summary {
    background: white;
    padding: 20px;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    margin-bottom: 20px;
  }

  .tax-summary h2 {
    color: #2d6a4f;
    margin-top: 0;
    margin-bottom: 15px;
    font-size: 1.2rem;
  }

  .tax-summary h3 {
    margin: 0 0 8px 0;
    font-size: 1rem;
  }

  .export-section {
    text-align: center;
    margin-top: 20px;
  }

  .btn-export {
    padding: 12px 24px;
    background: #2d6a4f;
    color: white;
    border: none;
    border-radius: 6px;
    text-decoration: none;
    display: inline-block;
    font-weight: bold;
    cursor: pointer;
  }

  .btn-export:hover {
    background: #1b4332;
  }

  .btn-secondary {
    padding: 10px 20px;
    background: #6c757d;
    color: white;
    text-decoration: none;
    border-radius: 6px;
    display: inline-block;
    margin-bottom: 20px;
  }

  .btn-secondary:hover {
    background: #5a6268;
  }
</style>
{% endblock %}

{% block content %}
<div class="statement-container">
    <div class="statement-header">
        <h1>Statement</h1>
        <p class="subtext">View your earnings activity for a selected period</p>
    </div>
    
    <a href="{% url 'sellers:dashboard' %}" class="btn-secondary">Back to Dashboard</a>
    
    <div class="date-filter-section">
        <form method="get" id="dateFilterForm">
            <div class="date-filter-row">
                <select name="period" id="period" onchange="toggleCustomDates()">
                    <option value="today" {% if period == 'today' %}selected{% endif %}>Today</option>
                    <option value="last_7_days" {% if period == 'last_7_days' %}selected{% endif %}>Last 7 days</option>
                    <option value="this_month" {% if period == 'this_month' %}selected{% endif %}>This month</option>
                    <option value="last_month" {% if period == 'last_month' %}selected{% endif %}>Last month</option>
                    <option value="custom" {% if period == 'custom' %}selected{% endif %}>Custom range</option>
                </select>
                
                <div id="customDates" style="display: {% if period == 'custom' %}flex{% else %}none{% endif %}; gap: 10px;">
                    <input type="date" name="date_from" value="{{ date_from }}" placeholder="From">
                    <input type="date" name="date_to" value="{{ date_to }}" placeholder="To">
                </div>
                
                <button type="submit" class="btn-apply">Apply</button>
            </div>
        </form>
    </div>
    
    <div class="period-summary">
        <h2>Seller Statement</h2>
        <div class="date-range">({{ start_date|date:"M d, Y" }} – {{ end_date|date:"M d, Y" }})</div>
    </div>
    
    <div class="transaction-section">
        <h2>Transaction Log</h2>
        <table class="transaction-table">
            <thead>
                <tr>
                    <th>Date</th>
                    <th>Source</th>
                    <th>Description</th>
                    <th style="text-align: right;">Amount</th>
                    <th style="text-align: right;">Balance</th>
                </tr>
            </thead>
            <tbody>
                {% for t in transactions %}
                <tr>
                    <td>{{ t.date|date:"M d" }}</td>
                    <td>{{ t.source }}</td>
                    <td>
                        {% if t.type == 'order' %}
                            <a href="{% url 'sellers:order_detail' t.order_id %}" style="color: #2d6a4f; text-decoration: none;">{{ t.description }}</a>
                        {% else %}
                            {{ t.description }}
                        {% endif %}
                    </td>
                    <td style="text-align: right;">
                        {% if t.amount >= 0 %}
                            <span class="amount-in">+${{ t.amount|floatformat:2 }}</span>
                        {% else %}
                            <span class="amount-out">${{ t.amount|floatformat:2 }}</span>
                        {% endif %}
                    </td>
                    <td style="text-align: right;" class="balance">${{ t.balance|floatformat:2 }}</td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="5" style="text-align: center; color: #666; padding: 30px;">No transactions in this period.</td>
                </tr>
                {% endfor %}
                {% if transactions and final_balance != 0 %}
                <tr style="background: #f5f5f5; font-weight: bold; border-top: 2px solid #333;">
                    <td colspan="3" style="text-align: right;">Total Gross Revenue</td>
                    <td style="text-align: right; color: #000;">+${{ total_revenue|floatformat:2 }}</td>
                    <td></td>
                </tr>
                <tr style="background: #f5f5f5; font-weight: bold;">
                    <td colspan="3" style="text-align: right;">Platform Commission</td>
                    <td style="text-align: right; color: #000;">−${{ total_commission|floatformat:2 }}</td>
                    <td></td>
                </tr>
                <tr style="background: #f5f5f5; font-weight: bold; border-top: 1px solid #999;">
                    <td colspan="3" style="text-align: right;">Net Change</td>
                    <td style="text-align: right; color: #000;">
                        {% if net_change >= 0 %}+{% endif %}${{ net_change|floatformat:2 }}
                    </td>
                    <td></td>
                </tr>
                <tr style="background: #f5f5f5; font-weight: bold;">
                    <td colspan="3" style="text-align: right;">Ending Balance</td>
                    <td></td>
                    <td style="text-align: right; color: #000;">${{ final_balance|floatformat:2 }}</td>
                </tr>
                {% endif %}
            </tbody>
        </table>
    </div>
    
    {% if final_balance != 0 %}
    <div class="tax-summary">
        <h2>Tax Summary (Reference Only)</h2>
        <div class="date-range">({{ start_date|date:"M d, Y" }} – {{ end_date|date:"M d, Y" }})</div>
        
        <div style="margin-top: 20px;">
            {% if tax_products_gst != 0 or tax_products_pst != 0 %}
            <div style="margin-bottom: 15px;">
                <h3 style="color: #2d6a4f; margin-bottom: 10px; font-size: 1.1rem;">Products</h3>
                <div style="padding-left: 20px;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                        <span>GST:</span>
                        <strong>${{ tax_products_gst|floatformat:2 }}</strong>
                    </div>
                    <div style="display: flex; justify-content: space-between;">
                        <span>PST:</span>
                        <strong>${{ tax_products_pst|floatformat:2 }}</strong>
                    </div>
                </div>
            </div>
            {% endif %}
            
            {% if tax_memberships_gst != 0 or tax_memberships_pst != 0 %}
            <div style="margin-bottom: 15px;">
                <h3 style="color: #2d6a4f; margin-bottom: 10px; font-size: 1.1rem;">Memberships</h3>
                <div style="padding-left: 20px;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                        <span>GST:</span>
                        <strong>${{ tax_memberships_gst|floatformat:2 }}</strong>
                    </div>
                    <div style="display: flex; justify-content: space-between;">
                        <span>PST:</span>
                        <strong>${{ tax_memberships_pst|floatformat:2 }}</strong>
                    </div>
                </div>
            </div>
            {% endif %}
            
            <div style="margin-top: 20px; padding-top: 15px; border-top: 2px solid #ddd;">
                <h3 style="color: #2d6a4f; margin-bottom: 10px; font-size: 1.1rem;">Total Tax Collected</h3>
                <div style="padding-left: 20px;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                        <span>GST:</span>
                        <strong>${{ total_gst|floatformat:2 }}</strong>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                        <span>PST:</span>
                        <strong>${{ total_pst|floatformat:2 }}</strong>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-top: 10px; padding-top: 10px; border-top: 1px solid #ddd; font-size: 1.1rem;">
                        <strong>Total:</strong>
                        <strong style="color: #2d6a4f;">${{ total_tax|floatformat:2 }}</strong>
                    </div>
                </div>
            </div>
        </div>
        
        <div style="margin-top: 15px; padding: 12px; background: #f0f0f0; border-radius: 4px; font-size: 0.85rem; color: #666; line-height: 1.5;">
            <strong>Note:</strong> Taxes are collected on behalf of sellers.<br>
            Sellers are responsible for tax reporting and remittance.
        </div>
    </div>
    {% endif %}
    
    <div class="export-section">
        <a href="?period={{ period }}{% if date_from %}&date_from={{ date_from }}{% endif %}{% if date_to %}&date_to={{ date_to }}{% endif %}&export=csv" class="btn-export">Export CSV</a>
    </div>
</div>

<script>
  function toggleCustomDates() {
    const periodSelect = document.getElementById('period');
    const customDates = document.getElementById('customDates');
    if (periodSelect.value === 'custom') {
      customDates.style.display = 'flex';
    } else {
      customDates.style.display = 'none';
    }
  }
  
</script>
{% endblock %}
